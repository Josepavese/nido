name: Cross-Platform CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        go-version: ['1.21']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ matrix.go-version }}

      # Install QEMU on Linux
      - name: Install QEMU (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86 qemu-utils

      # Install QEMU on macOS
      - name: Install QEMU (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install qemu

      # Install QEMU (Windows)
      - name: Install QEMU (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install qemu -y --no-progress
          $qemuPath = "C:\Program Files\qemu"
          echo "$qemuPath" >> $env:GITHUB_PATH
        shell: pwsh

      # Verify QEMU installation
      - name: Verify QEMU
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            qemu-system-x86_64 --version
            qemu-img --version
          else
            qemu-system-x86_64 --version
            qemu-img --version
          fi
        shell: bash

      # Build Nido and Validator (verifies compilation on all OSes)
      - name: Build Nido & Validator
        run: |
          go build -o nido${{ runner.os == 'Windows' && '.exe' || '' }} ./cmd/nido
          go build -o nido-validator${{ runner.os == 'Windows' && '.exe' || '' }} ./cmd/nido-validator

      # Add bin to PATH
      - name: Add bin to PATH
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            echo "$(pwd -W)/bin" >> $GITHUB_PATH
          else
            echo "$(pwd)/bin" >> $GITHUB_PATH
          fi
        shell: bash

      # Run unit tests
      - name: Run unit tests
        run: go test -v ./...

      # Run doctor command (all platforms)
      - name: Test nido doctor
        run: ./nido${{ runner.os == 'Windows' && '.exe' || '' }} doctor

      # Run config command (all platforms)
      - name: Test nido config
        run: ./nido${{ runner.os == 'Windows' && '.exe' || '' }} config || true

      # Linux-specific: Full VM lifecycle test
      - name: Full VM lifecycle test (Linux only)
        if: runner.os == 'Linux'
        run: |
          # Create a minimal test template
          # 1. Validator is already built in previous step
          
          # 2. Run Validator (Scenario: VMSpawnResources includes accel test)
          # We run specific scenario first to fail fast, or all.
          # For CI, let's run all scenarios to be safe.
          # We need to make sure we have a base image.
          # The qemu install step above gives us qemu-system-x86_64 but maybe not a cloud image.
          # The validator usually needs a --image argument or relies on default.
          # We'll use a tiny test image if possible, or skip image tests if no image.
          # Note: The placeholder created a 1G fake qcow2.
          
          # Creating a dummy "ubuntu" image to fool the validator logic if needed
          # But better: Use the standard validator execution
          
          ./nido-validator --nido ./nido --log-level debug

      # macOS/Windows: Limited testing (no nested virtualization)
      - name: Limited tests (macOS/Windows)
        if: runner.os != 'Linux'
        run: |
          ./nido${{ runner.os == 'Windows' && '.exe' || '' }} version
          ./nido${{ runner.os == 'Windows' && '.exe' || '' }} template list || true

  build-binaries:
    name: Build release binaries
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Build for all platforms
        run: |
          # Linux
          GOOS=linux GOARCH=amd64 go build -o dist/nido-linux-amd64 ./cmd/nido
          
          # macOS (Intel)
          GOOS=darwin GOARCH=amd64 go build -o dist/nido-darwin-amd64 ./cmd/nido
          
          # macOS (Apple Silicon)
          GOOS=darwin GOARCH=arm64 go build -o dist/nido-darwin-arm64 ./cmd/nido
          
          # Windows
          GOOS=windows GOARCH=amd64 go build -o dist/nido-windows-amd64.exe ./cmd/nido

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nido-binaries
          path: dist/
