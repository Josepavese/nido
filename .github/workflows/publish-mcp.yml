name: Publish MCP Server

on:
  release:
    types: [published]

jobs:
  bundle-and-publish:
    name: Build & Publish MCP Bundle
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to upload assets to the release
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.22"

      - name: Get Version
        id: version
        run: |
          echo "VERSION=${{ github.event.release.tag_name }}" >> $GITHUB_ENV
          echo "Building MCP Bundle for version: ${{ github.event.release.tag_name }}"

      - name: Build Binaries
        run: |
          mkdir -p bin
          echo "Building Linux amd64..."
          GOOS=linux   GOARCH=amd64 go build -o bin/nido-linux-amd64   ./cmd/nido
          
          echo "Building Darwin amd64..."
          GOOS=darwin  GOARCH=amd64 go build -o bin/nido-darwin-amd64  ./cmd/nido
          
          echo "Building Darwin arm64..."
          GOOS=darwin  GOARCH=arm64 go build -o bin/nido-darwin-arm64  ./cmd/nido
          
          echo "Building Windows amd64..."
          GOOS=windows GOARCH=amd64 go build -o bin/nido-windows-amd64.exe ./cmd/nido

      - name: Create MCP Bundle & Inject Manifest
        run: |
          mkdir -p dist
          
          # 1. Create the binary bundle
          # We package all binaries into a tarball
          tar -czf dist/nido.mcpb -C bin .
          
          # 2. Calculate SHA256 of the bundle
          SHA=$(sha256sum dist/nido.mcpb | awk '{print $1}')
          
          # Construct the download URL for the bundle we are about to upload
          # Note: uses the current release tag
          URL="https://github.com/${{ github.repository }}/releases/download/${{ env.VERSION }}/nido.mcpb"
          
          echo "Bundle SHA256: $SHA"
          echo "Bundle URL: $URL"
          
          # 3. Inject Values into server.json (SSOT Injection)
          # We use jq to update the placeholders in the template
          jq --arg v "${{ env.VERSION }}" --arg s "$SHA" --arg u "$URL" \
            '.version = $v | .packages[0].version = $v | .packages[0].fileSha256 = $s | .packages[0].identifier = $u' \
            server.json > dist/server.json
            
          # Debug output
          echo "Generated server.json:"
          cat dist/server.json

      - name: Upload MCP Assets to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/nido.mcpb
            dist/server.json
